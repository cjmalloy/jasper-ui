<form class="form" [formGroup]="originForm">
  <span></span>
  <h2>Backup & Restore</h2>

  <label>Origin:</label>
  <select #originSelect
          formControlName="origin"
          [value]="origin"
          (input)="selectOrigin(originSelect.value)">
    @if (!backupOrigins.includes(origin)) {
      <option [value]="origin">{{ origin || 'default' }}</option>
    }
    @for (origin of backupOrigins; track origin) {
      <option [value]="origin">{{ origin || 'default' }}</option>
    }
  </select>

  <label>Older than:</label>
  <input type="datetime-local" step="1" formControlName="olderThan">

  <span><!-- Buttons --></span>
  <span class="buttons right">
  </span>
</form>

<div class="backup buttons">
  @if (store.account.admin) {
    <button #backupButton
            type="button"
            [disabled]="!originForm.valid"
            (click)="showBackupOptions()"
            i18n-title title="Create Backup" i18n>+ backup</button>
    <button type="button"
            [disabled]="!originForm.valid"
            (click)="deleteOrigin()"
            i18n-title title="Delete all from origin" i18n>&ndash; delete</button>
  }

  @if (!uploading) {
    <button type="button"
            [disabled]="!originForm.valid"
            (click)="uploadFile.click()"
            i18n-title
            title="Upload Backup" i18n>+ upload</button>
  } @else {
    <app-loading></app-loading>
  }
  <input #uploadFile
         type="file"
         class="upload"
         (change)="upload(uploadFile?.files!)">

  @if (store.account.mod) {
    <button type="button"
            [disabled]="!originForm.valid"
            (click)="regen()"
            i18n-title
            title="Regenerate Metadata" i18n>♻️ regen</button>
  }
</div>

@for (e of serverError; track e) {
  <span><!-- Unexpected Error --></span>
  <div class="error">{{ e }}</div>
}

<app-backup-list [list]="list"
                 [origin]="origin"
                 (restoreRequested)="onRestoreRequested($event)"></app-backup-list>

<ng-template #backupOptions>
  <div class="context-menu" (click)="$event.stopPropagation()" [formGroup]="backupOptionsForm">
    <h3 i18n>{{ isRestoreMode ? 'Restore Options' : 'Backup Options' }}</h3>
    
    <label i18n>Include:</label>
    <div class="checkbox-group">
      <label>
        <input type="checkbox" formControlName="cache">
        <span i18n>Cache</span>
      </label>
      <label>
        <input type="checkbox" formControlName="ref">
        <span i18n>Refs</span>
      </label>
      <label>
        <input type="checkbox" formControlName="ext">
        <span i18n>Exts</span>
      </label>
      <label>
        <input type="checkbox" formControlName="user">
        <span i18n>Users</span>
      </label>
      <label>
        <input type="checkbox" formControlName="plugin">
        <span i18n>Plugins</span>
      </label>
      <label>
        <input type="checkbox" formControlName="template">
        <span i18n>Templates</span>
      </label>
    </div>

    <div class="form-group">
      <label for="newerThan" i18n>Newer than:</label>
      <input type="datetime-local" 
             id="newerThan" 
             step="1" 
             formControlName="newerThan">
    </div>

    <div class="buttons">
      <button type="button" (click)="confirmBackup()" i18n>OK</button>
      <button type="button" (click)="cancelBackup()" i18n>Cancel</button>
    </div>
  </div>
</ng-template>
