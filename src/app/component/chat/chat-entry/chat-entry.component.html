<div *ngIf="!ref.created && loading" class="loading-container"><app-loading></app-loading></div>
<span *ngIf="ref.created" class="gutter" [class.deleted]="deleted">
  <a *ngIf="ref.origin && !authors.length"
     class="origin tag"
     [routerLink]="['/tag', ref.origin]">
    {{ ref.origin }}</a>
  <ng-container *ngFor="let user of authorExts | async">
    <a class="user tag"
       [title]="formatAuthor(user.tag + user.origin)"
       [routerLink]="['/tag', user.tag + user.origin]">{{ user.name || formatAuthor(user.tag + user.origin) }}</a>&nbsp;
  </ng-container>
  <span class="timestamp" [title]="ref.modified?.toISOString()">{{ ref.modified?.fromNow() }}</span>
  &nbsp;|&nbsp;
</span>
<span class="message"
      [class.bubble]="focused"
      [class.focused]="focused"
      [class.deleted]="deleted"
      [class.sending]="!ref.created"
      [class.deleting]="deleting"
      [class.tagging]="tagging"
      (pointerenter)="allowActions = true"
      (pointerleave)="allowActions = false">
  <div [class.has-title]="clickableLink || title">
    <a *ngIf="clickableLink && (title || !media)" [href]="url | safe" target="_blank">{{ title }}</a>
    <span *ngIf="!clickableLink && (title || !expand)">{{ title }}</span>
    <app-md *ngIf="focused && bareRef?.comment"
            [origin]="ref.origin!"
            [text]="bareRef!.comment!"
            [plugins]="bareRef!.tags!"></app-md>
    <app-viewer [ref]="noComment"></app-viewer>
  </div>
  <div class="actions"
       *ngIf="ref.created"
       [style.pointer-events]="allowActions ? 'auto' : 'none'">
    <a *ngIf="comments"
       [routerLink]="['/ref', ref.url, 'comments']" [queryParams]="{ origin }" i18n>{comments, plural, =1 {1&thinsp;comment} other {{{ comments }}&thinsp;comments}}</a>
    <a *ngIf="!comments"
       [routerLink]="['/ref', ref.url]" [queryParams]="{ origin }" i18n>permalink</a>
    <a *ngIf="!deleting && (store.account.sysMod || writeAccess)"
       class="fake-link"
       (click)="deleting = true" i18n>delete</a>
    <span *ngIf="deleting" class="delete-confirm"> are you sure?&nbsp;
        <a class="fake-link" (click)="delete()">yes</a>&nbsp;/&nbsp;
        <a class="fake-link" (click)="deleting = false" i18n>no</a>&nbsp;
      </span>
    <a *ngIf="taggingAccess"
       class="fake-link"
       (click)="tagging = !tagging" i18n>tag</a>
    <span *ngIf="tagging" class="inline-tagging">
        <input #inlineTag
               (keydown)="$event.key === 'Enter' && addInlineTag() || true"
               type="text"
               inputmode="email"
               [pattern]="tagRegex"
               autocorrect="off"
               autocapitalize="none"
               appAutofocus>
        <button (click)="addInlineTag()" i18n>+</button>
      </span>
    <a *ngIf="!ref.origin && store.account.mod && !approved && !locked"
       class="fake-link"
       (click)="approve()" i18n>approve</a>
    <span class="approved icon" *ngIf="store.account.mod && approved" i18n-title title="Moderated" i18n>✔️</span>
  </div>
</span>
<ng-container *ngFor="let e of serverError">
  <span><!-- Server Error --></span>
  <div class="error">{{ e }}</div>
</ng-container>
