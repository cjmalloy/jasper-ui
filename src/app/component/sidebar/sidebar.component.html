<ng-container *mobxAutorun>
  <div class="row">
    <div class="toggle"
         *ngIf="showToggle"
         (click)="expanded = !expanded">☰</div>
    <div class="wide" *ngIf="store.view.type && (!home || store.view.search || store.view.filter.length || !query.page?.empty)">
      <app-search></app-search>
      <div class="show-remotes" *ngIf="expanded && store.view.type !== 'ref' && store.view.settings">
        <input id="show-remotes" #sr type="checkbox" [checked]="store.view.showRemotes" (input)="showRemotes = sr.checked">
        <label for="show-remotes" i18n>show remotes</label>
      </div>
    </div>
  </div>
  <ng-container *ngIf="expanded && store.view.type && (!home || store.view.search || store.view.filter.length || !query.page?.empty)">
    <app-query *ngIf="store.view.tag" [query]="tag" class="breadcrumbs"></app-query>
    <div class="row">
      <app-filter [type]="store.view.type!"></app-filter>
      <app-sort [type]="store.view.type!"></app-sort>
    </div>
  </ng-container>
  <app-debug *ngIf="expanded"></app-debug>
  <app-bulk *ngIf="expanded && store.view.type" [type]="store.view.type!"></app-bulk>
  <span class="button-bar">
    <ng-container *ngIf="store.account.user && (store.view.type === 'ref' || store.view.current === 'ref/summary')">
      <div *ngIf="!user && !plugin?.config?.submitInternal && !plugin?.config?.submitDm" class="submit-button" routerLink="/submit" [queryParams]="{ tag: localTag }">
        <span i18n-title title="Submit" i18n>📝️</span> <label i18n>Submit
        &nbsp;
        &nbsp;
        {{ plugin?.config?.submit || '' }}</label>
      </div>
      <div *ngIf="plugin?.config?.submitInternal" class="submit-button" routerLink="/submit/web" [queryParams]="{ tag: plugin!.tag, url: genUrl }">
        <span i18n-title title="Submit" i18n>📝️</span> <label i18n>Submit
        &nbsp;
        &nbsp;
        {{ plugin!.config!.submitInternal }}</label>
      </div>
      <div *ngIf="plugin?.config?.submitDm" class="submit-button" routerLink="/submit/dm" [queryParams]="{ tag: plugin!.tag, url: genUrl }">
        <span i18n-title title="Submit" i18n>📝️</span> <label i18n>Submit
        &nbsp;
        &nbsp;
        {{ plugin!.config!.submitDm }}</label>
      </div>
    </ng-container>
    <ng-container *ngIf="store.account.user && (home || store.account.tag === tag)">
      <div class="submit-button" routerLink="/submit/dm" [queryParams]="{ to: store.account.tag }">
        <span i18n-title title="Notes" i18n>✍️</span> <label i18n>Notes</label>
      </div>
    </ng-container>
    <ng-container *ngIf="store.account.tag !== tag && messages">
      <div class="submit-button" routerLink="/submit/dm" [queryParams]="{ to: tag }">
        <span i18n-title title="Direct Message" i18n>✉️</span> <label i18n>Message</label>
      </div>
    </ng-container>
    <ng-container *ngIf="store.account.editor && store.view.current === 'user'">
      <div class="submit-button" routerLink="/user">
        <span class="recolour" i18n-title title="Create User" i18n>👤️</span> <label i18n>Create User</label>
      </div>
    </ng-container>
    <ng-container *ngIf="user && (store.account.mod || store.account.tag === tag)">
      <div class="submit-button" [routerLink]="['/user', tag]">
        <span class="recolour" i18n-title title="Edit User" i18n>👤️</span> <label i18n>Edit User</label>
      </div>
    </ng-container>
    <ng-container *ngIf="store.account.editor && store.view.type === 'ext'">
      <div class="submit-button" [routerLink]="['/ext', store.view.template]">
        <span i18n-title title="Extend Tag" i18n>🎨️</span> <label i18n>Extend Tag</label>
      </div>
    </ng-container>
    <ng-container *ngIf="local && writeAccess && store.view.noQuery">
      <div class="submit-button" [routerLink]="['/ext', tag]">
        <span i18n-title title="Edit Tag" i18n>🎨️</span> <label i18n>Edit Tag</label>
      </div>
    </ng-container>
    <ng-container *ngIf="store.account.user && ext && (!local || !writeAccess) && store.view.noQuery">
      <div class="submit-button" [routerLink]="['/tags', tag]">
        <span i18n-title title="Edit Tag" i18n>🎨️</span> <label i18n>Edit Tag</label>
      </div>
    </ng-container>
  </span>

  <div class="hide tag-header" *ngIf="home">
    <h3><a [routerLink]="['/home']" i18n>Home</a></h3>

    <ng-container *ngIf="homeWriteAccess">
      <a *ngIf="admin.status.templates.home"
         class="sidebar-link edit"
         [routerLink]="['/tag', '+home']" i18n>
        edit
      </a>
    </ng-container>
  </div>
  <div class="hide tag-header" *ngIf="!home && store.view.tag">
    <h3 *ngIf="store.view.current === 'tag'">{{ ext?.name || tag }}</h3>
    <ng-container *ngIf="store.account.signedIn && tag && admin.status.templates.user">
      <button *ngIf="inBookmarks; else notBookmarked"
              class="bookmark"
              i18n-title title="Remove from top bar"
              (click)="removeBookmark()" i18n>&ndash; bookmark</button>
      <ng-template #notBookmarked>
        <button (click)="bookmark()"
                i18n-title title="Add to top bar"
                class="bookmark" i18n>+ bookmark</button>
      </ng-template>
      <ng-container *ngIf="user">
        <button *ngIf="inSubs; else notFollowing"
                class="subscribe"
                i18n-title title="Remove from home screen"
                (click)="unsubscribe()" i18n>&ndash; unfollow</button>
        <ng-template #notFollowing>
          <button (click)="subscribe()"
                  i18n-title title="Add to home screen"
                  class="subscribe" i18n>+ follow</button>
        </ng-template>
      </ng-container>
      <ng-container *ngIf="!user">
        <button *ngIf="inSubs; else notInSubs"
                class="subscribe"
                i18n-title title="Remove from home screen"
                (click)="unsubscribe()" i18n>&ndash; unsubscribe</button>
        <ng-template #notInSubs>
          <button (click)="subscribe()"
                  i18n-title title="Add to home screen"
                  class="subscribe" i18n>+ subscribe</button>
        </ng-template>
      </ng-container>
      <button *ngIf="inAlarms; else notInAlarms"
              class="alarm"
              i18n-title title="Remove alarm"
              (click)="removeAlarm()" i18n>🔇</button>
      <ng-template #notInAlarms>
        <button (click)="addAlarm()"
                i18n-title title="Add alarm"
                class="alarm" i18n>🔔</button>
      </ng-template>
    </ng-container>
  </div>

  <ng-container *ngIf="ui && ext">
    <div class="hide ui"
         [appTemplateUi]="ui"
         [ext]="ext"></div>
  </ng-container>

  <div *ngIf="root" class="hide template-root">
    <app-md *ngIf="ext?.config?.sidebar"
            [origin]="ext?.origin || ''"
            [text]="ext!.config!.sidebar"></app-md>
  </div>

  <div *ngIf="queue" class="hide template-queue">
    <div class="ext-text" *ngIf="ext?.config?.bounty">
      <b i18n>Bounty:</b> {{ ext?.config?.bounty }}
    </div>
    <div class="ext-text" *ngIf="ext?.config?.maxAge">
      <b i18n>Max Age:</b> {{ ext?.config?.maxAge }}
    </div>
    <div class="ext-text" *ngIf="ext?.config?.approvers?.length">
      <b i18n>Approvers:</b>
      <br>
      <ng-container *ngFor="let a of ext!.config!.approvers!">
        <a class="tag" [routerLink]="['/tag', a]">
          {{ a }}
        </a>
        <br>
      </ng-container>
    </div>
    <div *ngIf="isApprover">
      <a class="sidebar-link"
         [routerLink]="['/tag', prefix('plugin/invoice', ext!.tag)]" i18n>invoices</a>
    </div>
  </div>

  <div *ngIf="user || home" class="hide home">
    <div class="ext-text" *ngIf="$any(bookmarks | async).length" i18n>
      My Bookmarks:
      <br>
      <ng-container *ngFor="let book of bookmarks | async">
        <a class="tag" [routerLink]="['/tag', book.tag + book.origin]">
          {{ book.name || book.tag }}
        </a>
        <br>
      </ng-container>
      <br *ngIf="ext?.config?.subscriptions?.length">
    </div>
    <div class="ext-text" *ngIf="$any(userSubs | async).length" i18n>
      Following:
      <br>
      <ng-container *ngFor="let sub of userSubs | async">
        <a class="tag" [routerLink]="['/tag', sub.tag + sub.origin]">
          {{ sub.name || sub.tag }}
        </a>
        <br>
      </ng-container>
    </div>
    <div class="ext-text" *ngIf="$any(tagSubs | async).length" i18n>
      Subscribed to:
      <br>
      <ng-container *ngFor="let sub of tagSubs | async">
        <a class="tag" [routerLink]="['/tag', sub.tag + sub.origin]">
          {{ sub.name || sub.tag }}
        </a>
        <br>
      </ng-container>
    </div>
  </div>
</ng-container>
