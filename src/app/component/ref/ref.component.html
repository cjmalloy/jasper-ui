<div class="row">
  <ng-container *ngIf="admin.status.plugins.thumbnail">
    <div class="thumbnail"
         *ngIf="ref.tags?.includes('plugin/thumbnail') else defaultThumbnail"
         [style.background-image]="cssUrl(ref | thumbnail)"></div>
    <ng-template #defaultThumbnail>
      <div class="thumbnail default-thumbnail"></div>
    </ng-template>
  </ng-container>
  <div class="stack">
    <div class="link">
      <a *ngIf="webLink" [href]="ref.url">{{ ref.title || ref.url }}</a>
      <a *ngIf="!webLink && admin.status.plugins.comment" [routerLink]="['/ref', ref.url, 'comments']">{{ ref.title || ref.url }}</a>
      <a *ngIf="!webLink && !admin.status.plugins.comment" [routerLink]="['/ref', ref.url]">{{ ref.title || ref.url }}</a>
      <span class="host">({{ host }})</span>
      <span class="invoice icon" *ngIf="invoice" title="Invoice">🧾️</span>
      <span class="lock icon" *ngIf="locked" title="Locked">🔒️</span>
    </div>
    <div class="link-below">
      <div class="toggle"
           *ngIf="showToggle && (ref.comment || expandPlugins.length) && !editing"
           (click)="expanded = !expanded">
        <span class="toggle-plus" *ngIf="!expanded">＋</span>
        <span class="toggle-x" *ngIf="expanded">✕</span>
      </div>
      <div class="stack">
        <div class="info" [class.expanded]="!actionsExpanded">
          <span [title]="ref.created?.toISOString()">submitted {{ ref.created?.fromNow() }}</span>
          <ng-container *ngIf="authors.length">
            by
            <ng-container *ngFor="let user of authors">
              <a [routerLink]="['/tag', user]">
                {{ user.replace('+', '').replace('user/', '') }}</a>&nbsp;
            </ng-container>
          </ng-container>
          <ng-container *ngIf="tags.length">
            tagged
            <ng-container *ngFor="let tag of tags">
              <a [routerLink]="['/tag', tag]">{{ tag }}</a>&nbsp;
            </ng-container>
          </ng-container>
          <span [title]="ref.published?.toISOString()">published {{ ref.published?.fromNow() }}</span>
        </div>
        <app-embed *ngIf="expanded && expandInline && !editing"
                   [ref]="ref"
                   [expandPlugins]="expandPlugins"></app-embed>
        <div class="actions" [class.expanded]="actionsExpanded">
          <a *ngIf="admin.status.plugins.comment"
             [routerLink]="['/ref', ref.url, 'comments']">{{ comments.replace(' ', '&thinsp;') }}</a>
          <a [routerLink]="['/ref', ref.url, 'responses']">{{ responses.replace(' ', '&thinsp;') }}</a>
          <a [routerLink]="['/ref', ref.url, 'sources']">{{ sources.replace(' ', '&thinsp;') }}</a>
          <ng-container *ngIf="admin.status.plugins.graph">
            <a [routerLink]="['/ref', ref.url, 'graph']">graph</a>
          </ng-container>
          <a *ngIf="writeAccess$ | async"
             class="fake-link"
             (click)="editing = !editing">edit</a>
          <a *ngIf="!deleting && (account.mod || (writeAccess$ | async))"
             class="fake-link"
             (click)="deleting = true">delete</a>
          <span *ngIf="deleting" class="delete-confirm"> are you sure?
          <a class="fake-link" (click)="delete()">yes</a> /
          <a class="fake-link" (click)="deleting = false">no</a>
        </span>
          <a *ngIf="account.editor || (writeAccess$ | async)"
             class="fake-link"
             (click)="tagging = !tagging">tag</a>
          <span *ngIf="tagging" class="inline-tagging">
          <input #inlineTag
                 (keydown)="$event.key === 'Enter' && addInlineTag() || true"
                 type="email"
                 [pattern]="tagRegex"
                 autocorrect="off"
                 autocapitalize="none"
                 appAutofocus>
          <button (click)="addInlineTag()">+</button>
        </span>
          <ng-container *ngIf="canInvoice">
            <a [routerLink]="['/submit/invoice']"
               [queryParams]="{url: ref.url}">invoice</a>
          </ng-container>
          <ng-container *ngIf="invoice">
            <span *ngIf="disputed">disputed!</span>
            <a *ngIf="disputed && isAuthor"
               class="fake-link"
               (click)="accept()">accept</a>
            <a *ngIf="!disputed && isAuthor"
               class="fake-link"
               (click)="dispute()">dispute</a>
          </ng-container>
          <ng-container *ngIf="invoice">
            <span *ngIf="paid">paid!</span>
            <a *ngIf="!paid && isRecipient"
               class="fake-link"
               (click)="markPaid()">paid</a>
          </ng-container>
          <ng-container *ngIf="invoice">
            <span *ngIf="rejected">rejected!</span>
            <a *ngIf="!rejected && isRecipient"
               class="fake-link"
               (click)="reject()">reject</a>
          </ng-container>
          <a *ngIf="account.mod && !approved && !locked"
             class="fake-link"
             (click)="approve()">approve</a>
          <span class="approved icon" *ngIf="account.mod && approved" title="Moderated">✔️</span>
        </div>
      </div>
      <div class="toggle actions-toggle"
           (click)="actionsExpanded = !actionsExpanded">⚙️</div>
      <div class="toggle comments"
           *ngIf="admin.status.plugins.comment"
           [routerLink]="['/ref', ref.url, 'comments']">💬️</div>
    </div>
  </div>
</div>
<app-embed *ngIf="expanded && !expandInline && !editing"
           [ref]="ref"
           [expandPlugins]="expandPlugins"></app-embed>

<form *ngIf="editing" class="form" [formGroup]="editForm" (ngSubmit)="save()">

  <label for="comment">Abstract:</label>
  <textarea id="comment" formControlName="comment"></textarea>

  <label for="sources">Sources:</label>
  <div id="sources" class="form-group" formArrayName="sources">
    <button type="button" (click)="addSource()">+ Add another source</button>

    <div *ngFor="let source of sourcesForm.controls; let i=index">
      <label for="sources-{{ i }}">Source:</label>
      <input id="sources-{{ i }}" type="text" [formControl]="$any(source)">
      <button type="button" (click)="removeSource(i)">&ndash;</button>
      <div class="error" *ngIf="sourcesForm.at(i).touched && sourcesForm.at(i).errors?.['required']">
        Source must not be blank.
      </div>
    </div>
  </div>

  <label for="tags">Tags:</label>
  <div id="tags" class="form-group" formArrayName="tags">
    <button type="button" (click)="addTag()">+ Add another tag</button>

    <div *ngFor="let tag of tagsForm.controls; let i=index">
      <label for="tags-{{ i }}">Tag:</label>
      <input id="tags-{{ i }}"
             type="email"
             autocorrect="off"
             autocapitalize="none"
             [formControl]="$any(tag)">
      <button type="button" (click)="removeTag(i)">&ndash;</button>
      <div class="error" *ngIf="tagsForm.at(i).touched && tagsForm.at(i).errors?.['pattern']">
        Tags must be lower case letters and forward slashes. Must not start with a slash or contain two forward slashes in a row. Private
        tags start with an underscore.<br>
        (i.e. "science", "my/tag", or "_my/private/tag")
      </div>
      <div class="error" *ngIf="tagsForm.at(i).touched && tagsForm.at(i).errors?.['required']">
        Tag must not be blank.
      </div>
    </div>
  </div>

  <ng-container *ngFor="let e of serverError">
    <span><!-- Unexpected Error --></span>
    <div class="error">{{ e }}</div>
  </ng-container>

  <span><!-- Buttons --></span>
  <span class="form-group">
    <button type="submit" [disabled]="submitted && !editForm.valid">save</button>
    <button (click)="editing = false">cancel</button>
  </span>
</form>

