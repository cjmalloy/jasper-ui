<div class="row">
  <div *ngIf="store.account.user && admin.getPlugin('plugin/vote/up')"
       class="voting">
    <div class="vote-up"
         [class.on]="upvote"
         (click)="voteUp()"></div>
    <div class="vote-down"
         *ngIf="admin.getPlugin('plugin/vote/down')"
         [class.on]="downvote"
         (click)="voteDown()"></div>
  </div>
  <ng-container *ngIf="admin.getPlugin('plugin/thumbnail')">
    <div class="thumbnail"
         *ngIf="thumbnailUrl else defaultThumbnail"
         [style.background-image]="[repostRef, ref] | thumbnail | async"
         [style.border-radius.px]="thumbnailRadius">{{ thumbnailEmoji }}</div>
    <ng-template #defaultThumbnail>
      <div class="thumbnail"
           [class.default-thumbnail]="!thumbnailColor && !thumbnailEmoji"
           [style.background-color]="thumbnailColor"
           [style.border-radius.px]="thumbnailRadius">{{ thumbnailEmoji }}</div>
    </ng-template>
  </ng-container>
  <div class="stack">
    <div class="link" [class.remote]="!local">
      <a *ngIf="clickableLink" [href]="link | safe" target="_blank">{{ title }}</a>
      <a *ngIf="!clickableLink" [routerLink]="['/ref', url]" [queryParams]="{ origin: obsoleteOrigin }">{{ title }}</a><wbr>
      <span class="host">({{ host }})</span>
    </div>
    <div class="link-below">
      <div class="toggle"
           *ngIf="showToggle && (thread || commentNoTitle || expandPlugins.length)"
           (click)="editing ? editing = false : viewSource ? viewSource = false : store.local.setRefToggled(ref.url, ref.origin, expanded = !expanded)">
        <ng-container *ngIf="(editing || viewSource || expanded) else toggleExpanded">
          <span class="toggle-x">✕</span>
        </ng-container>
        <ng-template #toggleExpanded>
          <span class="toggle-plus" *ngIf="!fullscreen">＋</span>
          <span class="toggle-fullscreen" *ngIf="fullscreen">⛶</span>
        </ng-template>
      </div>
      <div class="stack">
        <div class="info" [class.expanded]="!actionsExpanded">
          <ng-container *ngIf="ref.created else notSubmitted">
            <span *ngIf="publishedIsSubmitted" [title]="ref.created.toISOString()" i18n>submitted {{ ref.created.fromNow() }}</span>
            <ng-container *ngIf="!publishedIsSubmitted">
              <span [title]="ref.published!.toISOString()" i18n>
                {{ publishedLabel }}
                {{ ref.published!.fromNow() }}</span>
            </ng-container>
            <span *ngIf="!modifiedIsSubmitted"
                  i18n-title
                  title="last edited {{ ref.modified!.fromNow() }}">*</span>
          </ng-container>
          <ng-template #notSubmitted>
            <span i18n>not found</span>
          </ng-template>
          <ng-container *ngIf="authors.length" i18n>
            by
            <ng-container *ngIf="authorExts$ | async as authorExts; else authorNoExts">
              <ng-container *ngFor="let user of authorExts">
                <a class="user tag"
                   [title]="formatAuthor(user.tag + user.origin)"
                   [routerLink]="['/tag', user.tag + user.origin]">{{ user.name || formatAuthor(user.tag + user.origin) }}</a>
              </ng-container>
            </ng-container>
            <ng-template #authorNoExts>
              <ng-container *ngFor="let t of userAuthors">
                <a class="user tag"
                   [title]="formatAuthor(t)"
                   [routerLink]="['/tag', t]">{{ formatAuthor(t) }}</a>
              </ng-container>
            </ng-template>
          </ng-container>
          <ng-container *ngIf="tags.length" i18n>
            tagged
            <ng-container *ngIf="tagExts$ | async as tagExts; else tagNoExts">
              <ng-container *ngFor="let e of tagExts">
                <a class="tag" [routerLink]="['/tag', e.tag]">{{ e.name || e.tag }}</a>
              </ng-container>
            </ng-container>
            <ng-template #tagNoExts>
              <ng-container *ngFor="let t of tags">
                <a class="tag" [routerLink]="['/tag', t]">{{ t }}</a>
              </ng-container>
            </ng-template>
          </ng-container>
          <ng-container *ngIf="recipients.length" i18n>
            to
            <ng-container *ngIf="recipientExts$ | async as recipientExts; else recipientNoExts">
              <ng-container *ngFor="let user of recipientExts">
                <a class="user tag"
                   [title]="formatAuthor(user.tag + user.origin)"
                   [routerLink]="['/tag', user.tag + user.origin]">{{ user.name || formatAuthor(user.tag + user.origin) }}</a>
              </ng-container>
            </ng-container>
            <ng-template #recipientNoExts>
              <ng-container *ngFor="let t of recipients">
                <a class="user tag"
                   [title]="formatAuthor(t)"
                   [routerLink]="['/tag', t]">{{ formatAuthor(t) }}</a>
              </ng-container>
            </ng-template>
          </ng-container>
          <span *ngIf="showAlarm && alarm" class="icon" [routerLink]="['/tag', alarm]" i18n-title title="Alarm ({{ alarm }})">🔔</span>
          <ng-container *ngFor="let icon of icons">
            <span *ngIf="showIcon(icon)"
                  class="icon"
                  (click)="clickIcon(icon)"
                  [appTitle]="icon"
                  [ref]="ref">{{ icon.label }}</span>
          </ng-container>
          <span *ngFor="let ui of infoUis"
                class="inline-ui"
                [appPluginInfoUi]="ui"
                [appMdPost]
                [ref]="ref"></span>
          <ng-container *ngIf="ref.created && !local" i18n>
            on <a class="origin tag" [routerLink]="['/tag', ref.origin || '*']">{{ ref.origin || 'default' }}</a>
          </ng-container>
          <ng-container *ngIf="addTags?.length" i18n>
            tagging refs
            <ng-container *ngIf="addTagExts$ | async as addTagExts; else addTagNoExts">
              <ng-container *ngFor="let e of addTagExts">
                <a class="tag" [routerLink]="['/tag', e.tag]">{{ e.name || e.tag }}</a>
              </ng-container>
            </ng-container>
            <ng-template #addTagNoExts>
              <ng-container *ngFor="let t of addTags || []">
                <a class="tag" [routerLink]="['/tag', t]">{{ t }}</a>
              </ng-container>
            </ng-template>
          </ng-container>
          <ng-container *ngIf="fromOrigin" i18n>
            from <a class="origin tag" [routerLink]="['/tag', fromOrigin]">{{ fromOrigin }}</a>
          </ng-container>
          <ng-container *ngIf="addOrigin" i18n>
            to <a class="origin tag" [routerLink]="['/tag', addOrigin]">{{ addOrigin }}</a>
          </ng-container>
        </div>
        <app-viewer *ngIf="expanded && expandInline && !editing && !viewSource"
                    class="viewer-inline"
                    [ref]="bareRef"
                    [tags]="plugins"
                    [disableResize]="disableResize"
                    (contextmenu)="unlockViewer($event)"
                    (copied)="copied.emit($event)"></app-viewer>
        <div class="actions" [class.expanded]="actionsExpanded">
          <ng-container *ngIf="store.account.user && !ref.created && !ref.upload">
            <a routerLink="/submit" [queryParams]="{ url: ref.url }" i18n>submit</a>
          </ng-container>
          <ng-container *ngIf="ref.created && !ref.upload">
            <a [routerLink]="['/ref', ref.url]" [queryParams]="{ origin: obsoleteOrigin }" i18n>permalink</a>
            <a *ngIf="store.account.user && !dm" routerLink="/submit/text" [queryParams]="{source: replySources, sourceTitle: ref.title, tag: replyTags}" i18n>reply</a>
            <a *ngIf="store.account.user && dm" routerLink="/submit/dm" [queryParams]="{source: replySources, sourceTitle: ref.title, tag: replyTags, to: replyTo}" i18n>reply</a>
            <a *ngIf="comments" [routerLink]="['/ref', ref.url, 'comments']" [queryParams]="{ origin: obsoleteOrigin }" i18n>{comments, plural, =1 {1&thinsp;comment} other {{{ comments }}&thinsp;comments}}</a>
            <a *ngIf="!comments && threads" [routerLink]="['/ref', ref.url, 'thread']" [queryParams]="{ origin: obsoleteOrigin }" i18n>{threads, plural, =1 {1&thinsp;reply} other {{{ threads }}&thinsp;replies}}</a>
            <a *ngIf="responses" [routerLink]="['/ref', ref.url, 'responses']" [queryParams]="{ origin: obsoleteOrigin }" i18n>{feed, select, true {{{ responses }}&thinsp;scraped} false {{responses, plural, =1 {1&thinsp;citation} other {{{ responses }}&thinsp;citations}}}}</a>
            <a *ngIf="parentComment" [routerLink]="['/ref', parentComment, 'comments']" [queryParams]="{ origin: obsoleteOrigin }" i18n>parent</a>
            <a *ngIf="parentCommentTop" [routerLink]="['/ref', parentCommentTop, 'comments']" [queryParams]="{ origin: obsoleteOrigin }" i18n>top</a>
            <a *ngIf="parentThreadTop" [routerLink]="['/ref', parentThreadTop, 'thread']" [queryParams]="{ origin: obsoleteOrigin }" i18n>parent</a>
            <a *ngIf="!parentComment && !parentThreadTop && sources === 1" [routerLink]="['/ref', ref.sources![0]]" [queryParams]="{ origin: obsoleteOrigin }" i18n>parent</a>
            <a *ngIf="!parentComment && !parentThreadTop && sources > 1" [routerLink]="['/ref', ref.url, 'sources']" [queryParams]="{ origin: obsoleteOrigin }" i18n>{{ sources }}&thinsp;sources</a>
            <app-inline-tag #action *ngIf="taggingAccess"
                            [action]="tag$"
                            (error)="serverError = [$event]" i18n>tag</app-inline-tag>
            <ng-container *ngIf="store.account.user && !local">
              <span class="fake-link" (click)="copy()" i18n>copy</span>
            </ng-container>
            <ng-container *ngIf="store.account.user && local">
              <a routerLink="/submit/web" [queryParams]="{ url, tag: 'plugin/repost' }" i18n>repost</a>
            </ng-container>
            <ng-container *ngIf="!hideEdit">
              <a *ngIf="writeAccess else source"
                 class="fake-link"
                 (click)="editing = !editing" i18n>edit</a>
              <ng-template #source>
                <a *ngIf="!local"
                   class="fake-link"
                   (click)="editing = !editing" i18n>diff</a>
                <a *ngIf="local"
                   class="fake-link"
                   (click)="viewSource = !viewSource" i18n>source</a>
              </ng-template>
            </ng-container>
            <app-confirm-action #action *ngIf="store.account.sysMod || taggingAccess" [action]="delete$" i18n>delete</app-confirm-action>
          </ng-container>
          <ng-container *ngIf="ref.upload">
            <ng-container *ngIf="ref.exists">
              <a [routerLink]="['/ref', ref.url]" [queryParams]="{ origin: obsoleteOrigin }" i18n>permalink</a>
            </ng-container>
            <ng-container *ngIf="store.account.user">
              <span class="fake-link" (click)="upload()" i18n>upload</span>
              <a *ngIf="store.account.user && !dm" routerLink="/submit/text" [queryParams]="{source: replySources, sourceTitle: ref.title, tag: replyTags}" i18n>reply</a>
              <a *ngIf="store.account.user && dm" routerLink="/submit/dm" [queryParams]="{source: replySources, sourceTitle: ref.title, tag: replyTags, to: replyTo}" i18n>reply</a>
              <app-inline-tag #action *ngIf="taggingAccess" [action]="tag$" (error)="serverError = [$event]" i18n>tag</app-inline-tag>
              <a class="fake-link" (click)="editing = !editing" i18n>edit</a>
            </ng-container>
            <app-confirm-action #action [action]="remove$" i18n>remove</app-confirm-action>
          </ng-container>
          <ng-container *ngIf="canInvoice">
            <a routerLink="/submit/invoice"
               [queryParams]="{url: ref.url}" i18n>invoice</a>
          </ng-container>
          <ng-container *ngFor="let a of actions">
            <a *ngIf="showAction(a)"
               class="fake-link"
               (click)="acts.apply(a, ref, repostRef)"
               [appTitle]="a"
               [appActionLabel]="a"
               [field]="label(a)"
               [ref]="ref"></a>
          </ng-container>
          <span class="fake-link show-more"
                (click)="showAdvanced($event)">…</span>
          <ng-template #actionsMenu>
            <div class="context-menu advanced-actions" (click)="$event.stopPropagation()">
              <a class="fake-link"
                 (click)="download()" i18n>download</a>
              <a *ngIf="mediaAttachment"
                 class="fake-link"
                 (click)="downloadMedia()" i18n>media</a>
              <ng-container *ngFor="let a of advancedActions">
                <a *ngIf="showAction(a)"
                   class="fake-link"
                   (click)="closeAdvanced() || acts.apply(a, ref, repostRef)"
                   [appTitle]="a"
                   [appActionLabel]="a"
                   [field]="label(a)"
                   [ref]="ref"></a>
              </ng-container>
            </div>
          </ng-template>
        </div>
      </div>
      <div class="toggle actions-toggle"
           (click)="actionsExpanded = !actionsExpanded">⚙️</div>
      <div class="toggle view"
           *ngIf="!admin.getPlugin('plugin/comment')"
           [routerLink]="['/ref', ref.url]"
           [queryParams]="{ origin: obsoleteOrigin }">🖇️️</div>
      <div class="toggle comments"
           *ngIf="admin.getPlugin('plugin/comment')"
           [routerLink]="['/ref', ref.url]"
           [queryParams]="{ origin: obsoleteOrigin }">💬️</div>
    </div>
  </div>
</div>
<app-viewer *ngIf="expanded && !expandInline && !editing && !viewSource"
            class="viewer-below"
            [ref]="bareRef"
            [tags]="plugins"
            [disableResize]="disableResize"
            (contextmenu)="unlockViewer($event)"
            (copied)="copied.emit($event)"></app-viewer>

<form *ngIf="editing else showErrors" class="form" [formGroup]="editForm" (ngSubmit)="save()">

  <app-ref-form [group]="editForm"
                (editorTags)="editorPlugins = $event"></app-ref-form>

  <ng-container *ngFor="let e of serverError">
    <span><!-- Unexpected Error --></span>
    <div class="error">{{ e }}</div>
  </ng-container>

  <span><!-- Buttons --></span>
  <span class="buttons form-array right">
    <div *ngIf="invalid && !force" class="overwrite warning" i18n-title title="Will drop all unknown plugins.">
      <input id="overwrite" type="checkbox" [(ngModel)]="overwrite" [ngModelOptions]="{standalone: true}">
      <label for="overwrite" i18n>Overwrite</label>
    </div>
    <div *ngIf="invalid && force" class="force error" i18n-title title="Will reset all plugins to defaults.">
      <input id="force" type="checkbox" [(ngModel)]="force" [ngModelOptions]="{standalone: true}">
      <label for="force" i18n>Force</label>
    </div>
    <button type="submit" [disabled]="submitted && !editForm.valid" i18n>save</button>
    <button (click)="editing = false" i18n>cancel</button>
  </span>
</form>

<form *ngIf="viewSource" class="form" [formGroup]="editForm">
  <app-ref-form [group]="editForm"></app-ref-form>
</form>

<ng-template #showErrors>
  <ng-container *ngFor="let e of serverError">
    <div class="error">{{ e }}</div>
  </ng-container>
  <div *ngIf="publishChanged"
       class="warning" i18n>
    * Published date was changed to be after source published date.
  </div>
</ng-template>
