<div *ngIf="!ref.created && loading" class="loading-container"><app-loading></app-loading></div>
<span *ngIf="ref.created" class="gutter" [class.deleted]="deleted">
  <a *ngIf="ref.origin && !authors.length"
     class="origin tag"
     [routerLink]="['/tag', ref.origin]">
    {{ ref.origin }}</a>
  <ng-container *ngFor="let user of authors">
    <a class="user tag"
       [routerLink]="['/tag', user]">
      {{ user.replace('+', '').replace('user/', '') }}</a>&nbsp;
  </ng-container>
  <span class="timestamp" [title]="ref.modified?.toISOString()">{{ ref.modified?.fromNow() }}</span>
  &nbsp;|&nbsp;
</span>
<span class="message"
      [class.focused]="focused"
      [class.deleted]="deleted"
      [class.sending]="!ref.created"
      [class.deleting]="deleting"
      [class.tagging]="tagging"
      (pointerenter)="allowActions = true"
      (pointerleave)="allowActions = false">
  <div [class.has-title]="webLink || ref.title">
    <a *ngIf="webLink && (ref.title || !media)" [href]="ref.url" target="_blank">{{ ref.title || ref.url }}</a>
    <span *ngIf="!webLink && (ref.title || !expand)">{{ ref.title || ref.url }}</span>
    <app-md *ngIf="ref.comment"
            [origin]="ref.origin"
            [text]="ref.comment"
            [plugins]="ref.tags"></app-md>
    <div *ngIf="image"
         class="image-expand"
         [style.background-image]="cssUrl(ref.plugins?.['plugin/image']?.url || ref.url)"
         appResize></div>
    <video *ngIf="video"
           class="video-expand"
           controls
           appResize>
      <source [src]="ref.plugins?.['plugin/video']?.url || ref.url">
    </video>
    <audio *ngIf="audio"
           class="audio-expand"
           controls>
      <source [src]="ref.plugins?.['plugin/audio']?.url || ref.url">
    </audio>
    <app-qr *ngIf="qr"
            [url]="ref.plugins?.['plugin/qr']?.url || ref.url"
            appResize></app-qr>
  </div>
  <div class="actions"
       *ngIf="ref.created"
       [style.pointer-events]="allowActions ? 'auto' : 'none'">
    <a *ngIf="admin.status.plugins.comment"
       [routerLink]="['/ref', ref.url, 'comments']" [queryParams]="{ origin }">{{ comments.replace(' ', '&thinsp;') }}</a>
    <a *ngIf="!admin.status.plugins.comment"
       [routerLink]="['/ref', ref.url]" [queryParams]="{ origin }">permalink</a>
    <a *ngIf="!deleting && writeAccess"
       class="fake-link"
       (click)="deleting = true">delete</a>
    <span *ngIf="deleting" class="delete-confirm"> are you sure?&nbsp;
        <a class="fake-link" (click)="delete()">yes</a>&nbsp;/&nbsp;
        <a class="fake-link" (click)="deleting = false">no</a>&nbsp;
      </span>
    <a *ngIf="!ref.origin && (store.account.editor || writeAccess)"
       class="fake-link"
       (click)="tagging = !tagging">tag</a>
    <span *ngIf="tagging" class="inline-tagging">
        <input #inlineTag
               (keydown)="$event.key === 'Enter' && addInlineTag() || true"
               type="text"
               inputmode="email"
               [pattern]="tagRegex"
               autocorrect="off"
               autocapitalize="none"
               appAutofocus>
        <button (click)="addInlineTag()">+</button>
      </span>
    <a *ngIf="!ref.origin && store.account.mod && !approved && !locked"
       class="fake-link"
       (click)="approve()">approve</a>
    <span class="approved icon" *ngIf="store.account.mod && approved" title="Moderated">✔️</span>
  </div>
</span>
<ng-container *ngFor="let e of serverError">
  <span><!-- Server Error --></span>
  <div class="error">{{ e }}</div>
</ng-container>
