import { DateTime } from 'luxon';
import { Plugin } from '../model/plugin';
import { Mod } from '../model/tag';
import { Template } from '../model/template';

export const chatTemplate: Template = {
  tag: 'chat',
  name: $localize`üó®Ô∏è Chat`,
  config: {
    type: 'lens',
    mod: $localize`üó®Ô∏è Chat`,
    experimental: true,
    genId: true,
    internal: true,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    submit: $localize`üó®Ô∏è chat/`,
    view: $localize`üó®Ô∏è`,
    description: $localize`Activates built-in Chat mode for viewing Refs.`,
    aiInstructions: `# chat
    The chat template creates chat rooms with real-time chat.
    When replying to a chat message, adding a notification to the user is optional, but not required.
    Notifying the user is only necessary if they have stepped away fom the chat room and need a ping.
    When replying to a chat message, be sure to include the same chat tag. For example, chat/general.
    Never include a title in a chat message, only a comment. If you include a title and a comment,
    only the title text will be visible until the user clicks on the chat message, which is poor form.
    Always give the shortest possible response. Responses longer than a line will be wrapped, and only
    show past the first line when focused. Respond in multiple messages if necessary.`,
    icons: [{ thumbnail: $localize`üó®Ô∏è`, order: 1 }],
    filters: [
      { query: 'chat', label: $localize`üó®Ô∏è chats`, title: $localize`Chats`, group: $localize`Templates üé®Ô∏è` },
    ],
    // language=CSS
    css: `
      .chat {
        .odd > * {
          background-color: var(--bg-accent);
          backdrop-filter: blur(1px);
        }
        .gutter {
          opacity: 0.5;
        }
        .focused {
          margin: 4px;
        }
        .messages {
          max-height: 80vh;
          .cdk-virtual-scroll-content-wrapper {
            display: grid;
            grid-template-columns: min-content auto;
            width: 100%;
          }
        }
      }
    `,
    form: [{
      key: 'authorTags',
      type: 'qtags',
      defaultValue: ['user', 'plugin/from'],
      props: {
        label: $localize`Author Tags:`,
        addText: $localize`+ Add another prefix`,
      }
    }],
  },
  defaults: {
    authorTags: ['user', 'plugin/from', '+plugin'],
    noFloatingSidebar: true,
  },
  schema: {
    optionalProperties: {
      authorTags: { elements: { type: 'string' } },
    }
  }
};

export const chatroomPlugin: Plugin = {
  tag: 'plugin/chat',
  name: $localize`üó®Ô∏è Chatroom`,
  config: {
    type: 'lens',
    mod: $localize`üó®Ô∏è Chat`,
    experimental: true,
    add: true,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    description: $localize`Activates built-in chatroom in a Ref.`,
    icons: [{ label: $localize`üó®Ô∏è`, order: -1 }],
    filters: [
      { query: 'plugin/chat', label: $localize`üó®Ô∏è chatroom`, title: $localize`Chatrooms`, group: $localize`Plugins üß∞Ô∏è` },
    ],
  },
  schema: {
    optionalProperties: {
      lobby: { elements: { type: 'string' } },
    }
  }
};

export const lobbyPlugin: Plugin = {
  tag: 'plugin/user/lobby',
  name: $localize`üö™Ô∏è Lobby`,
  config: {
    type: 'lens',
    mod: $localize`üó®Ô∏è Chat`,
    experimental: true,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    description: $localize`List users in lobby`,
  },
};

export const videoPlugin: Plugin = {
  tag: 'plugin/user/video',
  name: $localize`üìûÔ∏è Video Call`,
  config: {
    type: 'lens',
    mod: $localize`üó®Ô∏è Chat`,
    experimental: true,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    description: $localize`Join others in a video call`,
    rtcConfig: <RTCConfiguration> {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
      ],
    },
    gumConfig: {
      audio: true,
      video: {
        width: { ideal: 640 },
        height: { ideal: 640 }
      }
    },
    form: [{
      key: 'candidate',
      type: 'list',
      props: {
        label: $localize`Candidates: `,
        addText: $localize`+ Add Candidate`,
      },
      fieldArray: {
        wrappers: ['form-group'],
        fieldGroup: [{
          key: 'candidate',
          type: 'string',
        }, {
          key: 'sdpMid',
          type: 'string',
        }, {
          key: 'sdpMLineIndex',
          type: 'number',
        }, {
          key: 'usernameFragment',
          type: 'string',
        }],
      },

    }, {
      key: 'offer',
      wrappers: ['form-group'],
      props: {
        hide: '!field.parent.model.offer',
      },
      fieldGroup: [{
        key: 'type',
        type: 'string',
        props: {
          label: $localize`Offer Type`,
        },
      }, {
        key: 'sdp',
        type: 'textarea',
        props: {
          label: $localize`Offer SDP`,
        },
      }],
    }, {
      key: 'answer',
      wrappers: ['form-group'],
      props: {
        hide: '!field.parent.model.answer',
      },
      fieldGroup: [{
        key: 'type',
        type: 'string',
        props: {
          label: $localize`Answer Type`,
        },
      }, {
        key: 'sdp',
        type: 'textarea',
        props: {
          label: $localize`Answer SDP`,
        },
      }],
    }]
  },
  defaults: {
    candidate: [],
  },
  schema: {
    properties: {
      candidate: {
        elements: {
          optionalProperties: {
            candidate: { type: 'string', nullable: true },
            sdpMid: { type: 'string', nullable: true },
            sdpMLineIndex: { type: 'uint32', nullable: true },
            usernameFragment: { type: 'string', nullable: true },
          }
        }
      },
    },
    optionalProperties: {
      offer: {
        optionalProperties: {
          type: { type: 'string' },
          sdp: { type: 'string' },
        }
      },
      answer: {
        optionalProperties: {
          type: { type: 'string' },
          sdp: { type: 'string' },
        }
      },
    }
  }
};

export const chatMod: Mod = {
  plugin: [
    chatroomPlugin,
    lobbyPlugin,
    videoPlugin,
  ],
  template: [
    chatTemplate,
  ]
};
