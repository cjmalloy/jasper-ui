import { DateTime } from 'luxon';
import { Plugin } from '../model/plugin';
import { Mod } from '../model/tag';

export const feedPlugin: Plugin = {
  tag: 'plugin/script/feed',
  name: $localize`üóûÔ∏è RSS/Atom Feed`,
  config: {
    default: true,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    submit: $localize`üóûÔ∏è feed`,
    settings: $localize`feeds`,
    prefix: [
      'https://www.youtube.com/@',
      'https://feeds.feedblitz.com/',
    ],
    extensions: [
      '/feed',
      '/feed/',
      '/feed/articles/',
      '/feed.xml',
      '.rss',
      '/rss',
      '/rss/',
      '/rss/',
      '/rss.xml',
      '.atom',
      '/atom.xml',
      '/atom',
      '/atom/',
      '/atom/everything/',
      '/index.xml',
      '/blog-feed.xml',
    ],
    icons: [
      { label: $localize`üóûÔ∏è`, order: 3 },
      { tag: '-+plugin/cron',  label: $localize`üö´Ô∏è`, title: $localize`Pulling disabled`, order: -1 },
    ],
    description: $localize`Import entries from an RSS / Atom feed. The feed will be scraped on an interval you specify.`,
    actions: [
      { response: '+plugin/user/run', labelOn: $localize`cancel`, title: $localize`Cancel scraping feed.` },
      { tag: '+plugin/cron', labelOn: $localize`disable`, labelOff: $localize`enable`, title: $localize`Schedule this feed to pull every 15 minutes.` },
    ],
    advancedActions: [
      { response: '+plugin/user/run', labelOff: $localize`pull`, title: $localize`Scrape the feed and add any new Refs.`, confirm: $localize`Are you sure you want to pull?` },
    ],
    // language=Handlebars
    infoUi: `
      {{#if (interestingTags addTags)}} tagging refs {{/if}}
      {{#each (interestingTags addTags)}}
        #{{.}}
      {{/each}}`,
    form: [{
      key: 'matchText',
      type: 'list',
      props: {
        label: $localize`Text: `,
        addText: $localize`+ Match text`,
        title: $localize`Add a list of text to match against the feed entries. If any of the text is found, the entry will be added.`
      },
      fieldArray: {
        type: 'string',
        props: {
          label: $localize`üéØÔ∏è`,
        }
      },
    }, {
      key: 'addTags',
      type: 'tags',
    }],
    advancedForm: [{
      key: 'scrapeAudio',
      type: 'boolean',
      defaultValue: true,
      props: {
        label: $localize`Audio:`,
        title: $localize`Check feed entries for audio.`
      }
    }, {
      key: 'scrapeVideo',
      type: 'boolean',
      defaultValue: true,
      props: {
        label: $localize`Video:`,
        title: $localize`Check feed entries for video.`
      }
    }, {
      key: 'scrapeWebpage',
      type: 'boolean',
      props: {
        label: $localize`Scrape Webpage:`
      }
    }, {
      key: 'scrapeDescription',
      type: 'boolean',
      defaultValue: true,
      props: {
        label: $localize`Description:`
      }
    }, {
      key: 'scrapeContents',
      type: 'boolean',
      defaultValue: true,
      props: {
        label: $localize`Contents:`,
        title: $localize`Will overwrite description if found.`
      }
    }, {
      key: 'scrapeAuthors',
      type: 'boolean',
      props: {
        label: $localize`Authors:`
      }
    }, {
      key: 'scrapeThumbnail',
      type: 'boolean',
      defaultValue: true,
      props: {
        label: $localize`Thumbnail:`
      }
    }, {
      key: 'defaultThumbnail',
      wrappers: ['form-group'],
      props: {
        label: $localize`Default Thumbnail`,
        footer: true,
      },
      fieldGroup: [{
        key: 'url',
        type: 'image',
        props: {
          label: $localize`URL:`,
        },
      }, {
        key: 'color',
        type: 'color',
        props: {
          label: $localize`Color:`,
        },
      }, {
        key: 'emoji',
        type: 'string',
        props: {
          label: $localize`Emoji:`,
        },
      }, {
        key: 'radius',
        type: 'range',
        defaultValue: 0,
        props: {
          label: $localize`Radius:`,
          min: 0,
          max: 24,
          step: 4,
        },
      }],
    }, {
      key: 'stripQuery',
      type: 'boolean',
      props: {
        label: $localize`Strip Query:`,
        title: $localize`Strip all query parameters from the feed entry URLs.`
      }
    }, {
      key: 'stripHash',
      type: 'boolean',
      props: {
        label: $localize`Strip Hash:`,
        title: $localize`Strip all anchors from the feed entry URLs.`
      }
    }, {
      key: 'disableEtag',
      type: 'boolean',
      props: {
        label: $localize`Disable ETag Caching:`,
        title: $localize`Don't use the ETag to check if a feed is updated.`
      }
    }],
  },
  schema: {
    optionalProperties: {
      addTags: { elements: { type: 'string' } },
      disableEtag: { type: 'boolean' },
      etag: { type: 'string' },
      stripQuery: { type: 'boolean' },
      stripHash: { type: 'boolean' },
      scrapeWebpage: { type: 'boolean' },
      scrapeDescription: { type: 'boolean' },
      scrapeContents: { type: 'boolean' },
      scrapeAuthors: { type: 'boolean' },
      scrapeThumbnail: { type: 'boolean' },
      scrapeAudio: { type: 'boolean' },
      scrapeVideo: { type: 'boolean' },
      defaultThumbnail: {
        optionalProperties: {
          url: { type: 'string' },
          color: { type: 'string' },
          emoji: { type: 'string' },
          radius: { type: 'int32' },
        },
      }
    },
  },
};

export const feedMod: Mod = {
  plugin: [
    feedPlugin,
  ]
};
