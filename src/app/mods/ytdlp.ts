import { DateTime } from 'luxon';
import { Plugin } from '../model/plugin';
import { Mod } from '../model/tag';

export const ytdlpPlugin: Plugin = {
  tag: '_plugin/delta/ytdlp',
  name: $localize`▶️ YT-DLP`,
  config: {
    mod: $localize`▶️ YT-DLP`,
    default: false,
    generated: $localize`Generated by jasper-ui ${DateTime.now().toISO()}`,
    description: $localize`Cache with YT-DLP.`,
    actions: [
      { if: 'plugin/embed', tag: '_plugin/delta/ytdlp', labelOff: $localize`yt-dlp`, title: $localize`Download video with YT-DLP.`, global: true },
      { tag: '_plugin/delta/ytdlp', labelOn: $localize`cancel`, title: $localize`Cancel YT-DLP.` },
    ],
    timeoutMs: 900_000,
    requirements: `
      yt-dlp
      requests
    `,
    language: 'python',
    // language=python
    script: `
import tempfile
import os
import sys
import requests
import json
import yt_dlp
ref = json.load(sys.stdin)
origin = ref.get('origin', '')
url = ref.get('plugins', {}).get('plugin/embed', {}).get('url', ref.get('url', ''))
with tempfile.NamedTemporaryFile(delete=False) as temp_file:
  base_name = temp_file.name
  ydl_opts = {
    'outtmpl': f'{base_name}.%(ext)s',
    'remote_components': ['ejs:github'],
    'js_runtimes': {'bun': {'path': os.environ['JASPER_NODE']}},
  }
  saveStdout = sys.stdout
  sys.stdout = sys.stderr
  with yt_dlp.YoutubeDL(ydl_opts) as ydl:
    info = ydl.extract_info(url, download=True)
    ext = info.get('ext', 'mp4')
  sys.stdout = saveStdout

  # Find the actual downloaded file
  downloaded_file = f'{base_name}.{ext}'

  # Read the file content
  with open(downloaded_file, 'rb') as f:
    file_data = f.read()

  # Determine mime type based on extension
  mime_types = {
    'mp4': 'video/mp4',
    'webm': 'video/webm',
    'mp3': 'audio/mpeg',
    'm4a': 'audio/mp4',
    'mkv': 'video/x-matroska',
  }
  mime = mime_types.get(ext, 'application/octet-stream')

  response = requests.post(
    f"{os.environ['JASPER_API']}/pub/api/v1/repl/cache",
    data=file_data,
    headers={
      'Local-Origin': origin or 'default',
      'User-Role': 'ROLE_ADMIN',
      'Content-Type': mime,
    },
    params={
      'origin': origin,
      'title': ref['title'],
      'mime': mime,
    }
  )
  if not response.ok:
    print(f"Error {response.status_code}: {response.text}", file=sys.stderr)
    sys.exit(1)
  cache = response.json()
  ref.pop('metadata', None)
  os.remove(downloaded_file)
  ref.setdefault('tags', []).append('plugin/video')
  ref['tags'] = [t for t in ref['tags'] if not (t + '/').startswith('_plugin/delta/ytdlp/') and not (t + '/').startswith('plugin/embed/')]
  ref.setdefault('plugins', {}).setdefault('plugin/video', {})['url'] = cache['url']
  del ref.get('plugins', {})['plugin/embed']
  print(json.dumps({
    'ref': [{
      **cache,
      **ref,
    }],
  }))
    `,
  },
};

export const ytdlpMod: Mod = {
  plugin: [
    ytdlpPlugin,
  ]
};
